<?=$this->flashmessages(false)?>
<h2><?=$this->transEsc(($this->changePickup?"Change ":"")."Pickup Location")?></h2>
<div class="hold-form">
  <table class="pickupLocationTable">
    <? $showPreferredLibrary = isset($this->preferredLibrary) && ($this->preferredLibrary != "none") && ($this->preferredLibrary != ""); ?>
    <? $showAlternateLibrary = isset($this->alternateLibrary) && ($this->alternateLibrary != "none") && ($this->alternateLibrary != "") && (!isset($this->preferredLibrary) || ($this->alternateLibrary != $this->preferredLibrary)); ?>
    <? $showHomeLibrary = isset($this->homeLibrary) && ($this->homeLibrary != "99") && ($this->homeLibrary != "none") && (!isset($this->preferredLibrary) || ($this->homeLibrary != $this->preferredLibrary)) && (!isset($this->alternateLibrary ) || ($this->homeLibrary != $this->alternateLibrary)); ?>
    <? $selectedID = $showPreferredLibrary ? $this->preferredLibrary : ($showAlternateLibrary ? $this->alternateLibrary : ($showHomeLibrary ? $this->homeLibrary : "")) ?>
    <? if($selectedID != ""): ?>
      <tr><td colspan="2" class="modalSubheading center">Preferred Libraries</td></tr>
      <? foreach ($this->pickup as $lib): ?>
        <? if($showPreferredLibrary && $this->preferredLibrary == $lib['locationID'] ): ?>
          <tr>
            <td><span class="bigGreenCheck" name="check-<?=$this->escapeHtmlAttr($lib['locationID']).(($lib['locationID'] == $selectedID)?"":"\" style=\"color:#fff")?>"><span class="sr-only">Checked</span><i class="fa fa-check"></i></td>
            <td><button class="btn-dropdown btn-standardDropdown btn-pickupLocationPreferred" onclick="return SelectPickupLocation('<?=$this->escapeHtmlAttr($lib['locationID'])?>');"><?=$this->escapeHtml($lib['locationDisplay'])?></button></td>
          </tr>
          <? break; ?>
        <? endif; ?>
      <? endforeach; ?>
      <? foreach ($this->pickup as $lib): ?>
        <? if($showAlternateLibrary && $this->alternateLibrary == $lib['locationID'] ): ?>
          <tr>
            <td><span class="bigGreenCheck" name="check-<?=$this->escapeHtmlAttr($lib['locationID']).(($lib['locationID'] == $selectedID)?"":"\" style=\"color:#fff")?>"><span class="sr-only">Checked</span><i class="fa fa-check"></i></td>
            <td><button class="btn-dropdown btn-standardDropdown btn-pickupLocationPreferred" onclick="return SelectPickupLocation('<?=$this->escapeHtmlAttr($lib['locationID'])?>');"><?=$this->escapeHtml($lib['locationDisplay'])?></button></td>
          </tr>
          <? break; ?>
        <? endif; ?>
      <? endforeach; ?>
      <? foreach ($this->pickup as $lib): ?>
        <? if($showHomeLibrary && $this->homeLibrary == $lib['locationID'] ): ?>
          <tr>
            <td><span class="bigGreenCheck" name="check-<?=$this->escapeHtmlAttr($lib['locationID']).(($lib['locationID'] == $selectedID)?"":"\" style=\"color:#fff")?>"><span class="sr-only">Checked</span><i class="fa fa-check"></i></td>
            <td><button class="btn-dropdown btn-standardDropdown btn-pickupLocationPreferred" onclick="return SelectPickupLocation('<?=$this->escapeHtmlAttr($lib['locationID'])?>');"><?=$this->escapeHtml($lib['locationDisplay'])?> (Home)</button></td>
          </tr>
          <? break; ?>
        <? endif; ?>
      <? endforeach; ?>
      <tr><td colspan="2">&nbsp;</td></tr>
      <tr><td colspan="2" class="center"><button class="btn-default btn-wide" onclick="ToggleOtherLibraries(this)">Show Other Libraries</button></tr>
      <tr class="otherLibraryRow" style="display:none"><td colspan="2">&nbsp;</td></tr>
      <tr class="otherLibraryRow" style="display:none"><td colspan="2" class="modalSubheading center">Other Libraries</td></tr>
    <? endif; ?>
    <? foreach ($this->pickup as $lib): ?>
      <? if((!isset($this->preferredLibrary) || ($this->preferredLibrary != $lib['locationID'])) && 
            (!isset($this->alternateLibrary) || ($this->alternateLibrary != $lib['locationID'])) && 
            (!isset($this->homeLibrary)      || ($this->homeLibrary != $lib['locationID']))): ?>
        <tr class="otherLibraryRow"<?=(($selectedID=="") ? "" : " style='display:none'")?>>
          <td><span class="bigGreenCheck" name="check-<?=$this->escapeHtmlAttr($lib['locationID']).(($lib['locationID'] == $selectedID)?"":"\" style=\"color:#fff")?>" style="color:#fff"><span class="sr-only">Checked</span><i class="fa fa-check"></i></td>
          <td><button class="btn-dropdown btn-standardDropdown btn-pickupLocation" onclick="return SelectPickupLocation('<?=$this->escapeHtmlAttr($lib['locationID'])?>');"><?=$this->escapeHtml($lib['locationDisplay'])?></button></td>
        </tr>
      <? endif; ?>
    <? endforeach; ?>
  </table>
</div>
<div class="modal-footer">
  <div id="holdFooter">
    <form action="" class="form-horizontal" method="post" name="placeHold" target="loginFrame">
      <input type="hidden" name="gatheredDetails[comment]" value="" />
      <input type="hidden" name="gatheredDetails[requiredBy]" value="<?=(isset($this->gatheredDetails['requiredBy']) && !empty($this->gatheredDetails['requiredBy'])) ? $this->escapeHtmlAttr($this->gatheredDetails['requiredBy']) : $this->escapeHtmlAttr($this->defaultRequiredDate)?>"/>
      <input type="hidden" name="gatheredDetails[pickUpLocation]" value="<?=$selectedID?>">
      <? if(isset($this->gatheredDetails['itemId']) && !empty($this->gatheredDetails['itemId'])): ?>
        <input type="hidden" name="gatheredDetails[itemID]" value="<?=$this->gatheredDetails['itemId']?>">
      <? endif; ?>
      <input type="hidden" name="placeHold" value="1">
      <? if( $this->changePickup || $this->bulkHold ): ?>
        <input type="hidden" name="<?=($this->changePickup ? "changePickup" : "bulkHold")?>" value="true">
        <input type="hidden" name="referrer" value="<?=$this->referrer?>">
        <? foreach( $this->ids as $id ): ?>
          <input type="hidden" name="<?=($this->changePickup ? "updateIDs[]" : "holdIDs[]")?>" value="<?=$id?>">
        <? endforeach; ?>
        <? foreach( $this->titles as $title ): ?>
          <input type="hidden" name="holdTitles[]" value="<?=$title?>">
        <? endforeach; ?>
      <? endif; ?>
      <span id="holdLocationError" class="formError">You must select a pickup location for your hold.</span>
      <button class="btn-default btn-wide"<?=(isset($this->preferredLibrary)?"":" disabled")?>>Okay</button>
    </form>
  </div>
  <div id="loadingFooter" style="display:none;padding:9px;color:#3d3d3d">
    <span><i class="fa fa-spinner"></i></span>
    <span>&nbsp;Loading...</span>
  </div>

  <script type="text/javascript">
    function ToggleOtherLibraries(swapButton) {
      var shown = $(swapButton).hasClass("shown");
      if( shown ) {
        $('.otherLibraryRow').css({"display":"none"});
        $(swapButton).html("Show Other Libraries");
        $(swapButton).removeClass("shown");
      } else {
        $('.otherLibraryRow').css({"display":"table-row"});
        $(swapButton).html("Hide Other Libraries");
        $(swapButton).addClass("shown");
      }
    }

    function SelectPickupLocation(chosenID) {
      var currentID = $('input[name="gatheredDetails[pickUpLocation]"]').val();
      $('span[name="check-' + currentID + '"]').css("color","#fff");
      $('input[name="gatheredDetails[pickUpLocation]"]').val(chosenID);
      $('span[name="check-' + chosenID + '"]').css("color","");
      $('#holdLocationError').css('display','none');
    }

    function ProcessHoldForm() {
      if( ($('input[name="gatheredDetails[pickUpLocation]"]').val() == "") || ($('input[name="gatheredDetails[pickUpLocation]"]').val() == "none") ) {
        $('#holdLocationError').css('display','inherit');
      } else {
        $('#holdFooter').css('display', 'none');
        $('#loadingFooter').css('display', 'block');
        
        Lightbox.addFormHandler('placeHold', null);
        $('form[name="placeHold"]').attr("action", Lightbox.lastURL);
        $('form[name="placeHold"]').get(0).submit();
      }
      return false;
    }

    Lightbox.addFormHandler('placeHold', ProcessHoldForm);
  </script>
</div>
