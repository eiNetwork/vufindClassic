<?
  // Set up page title:
  $lookfor = $this->results->getUrlQuery()->isQuerySuppressed() ? '' : $this->params->getDisplayQuery();
  if (isset($this->overrideTitle)) {
      $this->headTitle($this->overrideTitle);
  } else {
      $this->headTitle($this->translate('Search Results') . (empty($lookfor) ? '' : " - {$lookfor}"));
  }

  // update the search boxes.  sort of hacky, but it's the only way I could get it to work.
  // -- BJP
  if( $lookfor != "" ) {
?>
<script type="text/javascript">
  $("input[name=lookfor]").val("<?= str_replace("\"", "\\\"", $lookfor) ?>");
</script>
<?
  }

  // Enable cart if appropriate:
  $this->showCartControls = $this->params->getOptions()->supportsCart() && $this->cart()->isActive();
  // Enable bulk options if appropriate:
  $this->showBulkOptions = $this->params->getOptions()->supportsCart() && $this->showBulkOptions;

  // Load Javascript dependencies into header:
  $this->headScript()->appendFile("check_item_statuses.js");
  $this->headScript()->appendFile("check_save_statuses.js");

  // get results
  $recordTotal = $this->results->getResultTotal();
  $facetSet = $this->results->getRecommendations('side')[0]->getFacetSet();
  $resultCategories = $facetSet ? $facetSet["format_category"]["list"] : [];
  $resultFormats = $facetSet ? $facetSet["format"]["list"] : [];
  $usableFormats = array();
  $usableCategories = [];
  foreach( $resultFormats as $thisFormat ):
    $usableFormats[$thisFormat["value"]] = $thisFormat;
  endforeach;
?>

<div class="row">
  <?=$this->flashmessages()?>
  <div class="EIN-hide-m EIN-hide-t EIN-col-4 resultsLeftBar" id="facetsDiv">
    <? /* Narrow Search Options */ ?>
    <div class="EIN-hide-m EIN-hide-t EIN-col-12 facetTitle">Filter Results</div>
    <div class="EIN-col-m-12" style="float:none">
      <? foreach ($this->results->getRecommendations('side') as $current): ?>
        <?=$this->recommend($current)?>
      <? endforeach; ?>
      <? /* End Narrow Search Options */ ?>
    </div>
  </div>
  <div class="EIN-col-m-12 EIN-col-t-12 EIN-col-8 resultsRightBar">
    <div class="EIN-col-m-12">
      <table style="width:100%; text-align:center">
        <tr>
          <? foreach($this->formatCategories->types as $category): ?>
            <? $formatTypes = explode(",", $category);  $categoryName = array_splice($formatTypes, 0, 1)[0]; ?>
            <? $imageName = str_replace(" ", "", $categoryName); ?>
            <? $resultCount = $usableFormats["Category: " . $categoryName]["count"]; ?>
            <? $urlParams = $this->results->getUrlQuery()->getParamArray();  $firstType = null;  foreach($formatTypes as $type): ?>
              <? if( array_key_exists($type, $usableFormats) ): ?>
                <? if( $firstType == null ): ?>
                  <? $firstType = $type; $usableCategories[] = $categoryName; ?>
                <? else: ?>
                  <? $urlParams["filter"][] = "~format:\"" . $type . "\""; ?>
                <? endif; ?>
              <? endif; ?>
            <? endforeach; ?>
            <td><div style="position:relative"<?=(($categoryName=="Music")?" class=\"hideOverflow\"":"")?>>
              <? if( $firstType != null ): ?>
                <a href="<?=$this->currentPath() . $this->results->getUrlQuery()->addFacet('format', $firstType, 'OR', $urlParams)?>">
              <? endif; ?>
              <div class="EIN-m-12" style="height:3px"></div>
              <img class="formatIcon" src="../themes/truefit/images/icons/<?=$imageName . (($firstType == null) ? "Disabled" : "")?>.png"/><div class="formatIconCount"><span class="badge"><?=number_format($resultCount)?></span></div>
              <? if( $firstType != null ): ?>
                </a>
              <? endif; ?>
              </div></td>
          <? endforeach; ?>
        </tr>
        <tr>
          <? foreach($this->formatCategories->types as $category): ?>
            <? $formatTypes = explode(",", $category);  $categoryName = array_splice($formatTypes, 0, 1)[0]; ?>
            <td class="formatName"<?=(in_array($categoryName, $usableCategories)?"":" style=\"color:#cdcdcd\"") . ">" . $categoryName?></td>
          <? endforeach; ?>
        </tr>
      </table>
      <hr style="margin:5px 0">
    </div>
    <? if ($recordTotal > 0): ?>
      <div class="EIN-col-m-12">
        <table style="margin:auto;text-align:center">
          <tr>
            <td style="padding-left:10px" class="EIN-hide"><button class="btn-default" onClick="Lightbox.get('MyResearch', 'Facets')">Filter Results</button></td>
            <td style="padding-left:10px" id="resultsCount"><span><strong><?=$this->localizedNumber($recordTotal)?></strong> titles sorted by </span></td>
            <td style="padding-left:5px"><?=$this->render('search/controls/sort.phtml')?></td>
          </tr>
        </table>
        <script type="text/javascript">
          jQuery(document).ready(function() {
            setTimeout(function() {
              while($('#resultsCount').parents("table").width() > $(window).innerWidth()) {
                var fontSize = parseInt($('#resultsCount').css("font-size"));
                $('#resultsCount').css("font-size", (fontSize - 1) + "px");
              }
            }, 100);
          });
        </script>
        <hr style="margin:5px 0">
      </div>
    <? endif; ?>
    <? /* End Listing Options */ ?>

    <div class="EIN-col-m-12">
      <? if ($recordTotal < 1): ?>
        <p style="padding:8px">
          <? if (isset($this->overrideEmptyMessage)): ?>
            <?=$this->overrideEmptyMessage?>
          <? else: ?>
            <?=$this->transEsc('nohit_prefix')?> - <strong><?=$this->escapeHtml($lookfor)?></strong> - <?=$this->transEsc('nohit_suffix')?>
          <? endif; ?>
        </p>
        <? if (isset($this->parseError)): ?>
          <p class="alert alert-danger"><?=$this->transEsc('nohit_parse_error')?></p>
        <? endif; ?>
        <? foreach (($top = $this->results->getRecommendations('top')) as $current): ?>
          <?=$this->recommend($current)?>
        <? endforeach; ?>
        <? foreach ($this->results->getRecommendations('noresults') as $current): ?>
          <? if (!in_array($current, $top)): ?>
            <?=$this->recommend($current)?>
          <? endif; ?>
        <? endforeach; ?>
      <? else: ?>
        <?=$this->render('search/list-' . $this->params->getView() . '.phtml')?>
        <?=$this->paginationControl($this->results->getPaginator(), 'Sliding', 'search/pagination.phtml', array('results' => $this->results))?>
      <? endif; ?>
    </div>
    <? /* End Main Listing */ ?>
  </div>
</div>
<script type="text/javascript">
  $('#saveSearchButton').prop('disabled', false);
  $('#saveSearchButton').parent().removeClass('disabled');
  $('#saveSearchButton').parent().attr('href', '<?=$this->url('myresearch-savesearch')?>?save=<?=urlencode($this->results->getSearchId())?>');
</script>
